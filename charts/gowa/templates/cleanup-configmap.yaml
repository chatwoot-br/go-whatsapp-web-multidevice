{{- if .Values.cleanup.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "gowa.fullname" . }}-cleanup-config
  labels:
    {{- include "gowa.labels" . | nindent 4 }}
data:
  cleanup-crontab: |
    # Cleanup old files from media directories
    # Schedule: {{ .Values.cleanup.schedule }}
    # Retention: {{ .Values.cleanup.retentionDays }} days
    {{ .Values.cleanup.schedule }} /cleanup/cleanup.sh >> /proc/1/fd/1 2>&1
  cleanup.sh: |
    #!/bin/sh
    set -e
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] Starting cleanup of files older than {{ .Values.cleanup.retentionDays }} days..."
    {{- range .Values.cleanup.directories }}
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] Cleaning /shared-data/{{ . }}..."
    find /shared-data/{{ . }} -type f -mtime +{{ $.Values.cleanup.retentionDays }} -delete 2>/dev/null || true
    find /shared-data/{{ . }} -type d -empty -delete 2>/dev/null || true
    {{- end }}
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] Cleanup completed successfully"
{{- end }}
